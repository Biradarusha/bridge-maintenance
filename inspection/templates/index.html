{% extends 'base.html' %}
{% load static %}

{% block extrahead %}
<!-- Lightbox CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet">
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<!-- Lightbox JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
/* ===== Mini Map & Observation Styling ===== */
.mini-map-img {
    cursor: pointer;
    width: 150px;
    border: 1px solid #ccc;
    border-radius: 4px;
    transition: transform 0.2s ease;
}
.mini-map-img:hover {
    transform: scale(1.05);
}
.obs-img {
    display: block;
    margin-bottom: 5px;
    max-width: 150px;
    border: 1px solid #ddd;
    border-radius: 4px;
}
.mini-map-container {
    margin-bottom: 10px;
    text-align: center;
}
.mini-map-label {
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
}
.observation-img-block { 
    position: relative; 
    margin-bottom: 15px;
}
.bridge-details, .bridge-section { margin-bottom: 30px; }
.details-grid, .observation-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}
.summary-cards { display: flex; gap: 20px; margin-bottom: 30px; }
.summary-card { padding: 15px; border: 1px solid #ddd; border-radius: 5px; flex: 1; }
.stats-grid { display: flex; justify-content: space-between; margin-top: 10px; }
.stat.critical { color: red; }
.stat.moderate { color: orange; }
.stat.cleaning { color: green; }
.observation-list { padding-left: 20px; }
</style>
{% endblock %}

{% block content %}
<section class="hero">
  <div class="hero-content">
    <h1><i class="fas fa-bridge"></i> {{ project.name }} - Bridge Inspection Report</h1>
    <p>{{ project.description }}</p>
  </div>
</section>

<div class="content-wrapper">
  <!-- Summary Cards -->
  <div class="summary-cards">
    {% for stat in summary_stats %}
      <div class="summary-card">
        <h3>Critical Observations</h3>
        <div class="stats-grid">
          <div class="stat critical">{{ stat.critical_total }} Total</div>
          <div class="stat critical">{{ stat.critical_lhs }} LHS</div>
          <div class="stat critical">{{ stat.critical_rhs }} RHS</div>
        </div>
      </div>
      <div class="summary-card">
        <h3>Moderate Observations</h3>
        <div class="stats-grid">
          <div class="stat moderate">{{ stat.moderate_total }} Total</div>
          <div class="stat moderate">{{ stat.moderate_lhs }} LHS</div>
          <div class="stat moderate">{{ stat.moderate_rhs }} RHS</div>
        </div>
      </div>
      <div class="summary-card">
        <h3>Cleaning Required</h3>
        <div class="stats-grid">
          <div class="stat cleaning">{{ stat.cleaning_total }} Total</div>
          <div class="stat cleaning">{{ stat.cleaning_lhs }} LHS</div>
          <div class="stat cleaning">{{ stat.cleaning_rhs }} RHS</div>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Bridge Details -->
  {% for bridge in bridges %}
  <div class="bridge-details">
    <h2>Bridge Information</h2>
    <div class="details-grid">
      <div>Road Name: NH-9</div>
      <div>Direction: {{ bridge.direction }}</div>
      <div>Chainage KM: {{ bridge.chainage_km }} LHS & RHS</div>
      <div>Inspection Date: {{ bridge.inspection_date }}</div>
      <div>Structure Type: {{ bridge.structure_type }}</div>
      <div>Structure No: {{ bridge.structure_no }}</div>
      <div>Chainage From: {{ bridge.chainage_from }}</div>
      <div>Chainage To: {{ bridge.chainage_to }}</div>
      <div>Level: {{ bridge.level }}</div>
      <div>Structure ID: {{ bridge.structure_id }}</div>
      <div>Side: {{ bridge.side }}</div>
    </div>
  </div>

  <!-- LHS & RHS Observations -->
  {% for side in sides %}
  <div class="bridge-section">
    <div class="section-header">
      <h2>{{ bridge.name }} {{ side|upper }}</h2>
    </div>
    <div class="observation-grid">
      {% for observation in observations %}
        {% if observation.bridge.id == bridge.id %}
          {% if observation.side == side or observation.side == 'both' %}
          <div class="observation-card">
            <div class="observation-img-block">
              
              <!-- Mini Map -->
              {% if observation.map_coordinates %}
              <div class="mini-map-container">
                <div class="mini-map-label">Click map to open in new tab</div>
                <img src="{{ observation.map_image.url }}" 
                     alt="Mini Map" class="mini-map-img"
                     onclick="openMapInNewTab('{{ observation.map_coordinates|escapejs }}', '{{ observation.title|escapejs }}')">
              </div>
              {% endif %}

              <!-- Lightbox Images: Thumbnail + hidden gallery -->
              {% with observation.images.all|first as first_image %}
                {% if first_image %}
                  <!-- Thumbnail -->
                  <a href="{{ first_image.image.url }}" 
                     data-lightbox="gallery-{{ observation.id }}" 
                     data-title="{{ first_image.caption|default:observation.title }}">
                    <img src="{{ first_image.image.url }}" alt="Observation Thumbnail" class="obs-img">
                  </a>

                  <!-- Hidden images for gallery -->
                  {% for image in observation.images.all %}
                    {% if image != first_image %}
                      <a href="{{ image.image.url }}" 
                         data-lightbox="gallery-{{ observation.id }}" 
                         data-title="{{ image.caption|default:observation.title }}" 
                         style="display:none;"></a>
                    {% endif %}
                  {% endfor %}
                {% endif %}
              {% endwith %}
            </div>

            <div class="observation-content">
              <h4>Observations:</h4>
              <ul class="observation-list">
                {% for item in observation.description.splitlines %}
                  <li>{{ item }}</li>
                {% endfor %}
              </ul>
            </div>
          </div>
          {% endif %}
        {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endfor %}
  {% endfor %}
</div>

<!-- Scripts -->
<script>
lightbox.option({
  'resizeDuration': 200,
  'wrapAround': true,
  'alwaysShowNavOnTouchDevices': true,
  'showImageNumberLabel': true
});

function openMapInNewTab(coords, title) {
    if (!coords) { alert("Coordinates not available"); return; }
    
    const [lat, lng] = coords.split(',').map(Number);
    if (isNaN(lat) || isNaN(lng)) { alert("Invalid coordinates"); return; }

    const mapHtml = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Map: ${title}</title>
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
        <style>body{margin:0;padding:0;}#map{height:100vh;width:100vw;}.map-header{position:absolute;top:10px;left:50px;z-index:1000;background:white;padding:10px;border-radius:5px;box-shadow:0 2px 5px rgba(0,0,0,0.2);}</style>
    </head>
    <body>
        <div class="map-header"><h3>${title}</h3><p>Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}</p></div>
        <div id="map"></div>
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"><\/script>
        <script>
            const map = L.map('map').setView([${lat}, ${lng}], 17);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap contributors' }).addTo(map);
            L.marker([${lat}, ${lng}]).addTo(map).bindPopup('${title.replace(/'/g, "\\'")}<br>Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}').openPopup();
        <\/script>
    </body>
    </html>`;
    const newTab = window.open('', '_blank');
    newTab.document.write(mapHtml);
    newTab.document.close();
}
</script>
{% endblock %}
