<!DOCTYPE html>
<html>
<head>
    <title>Observation Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" />
    <style>
        body, html { height: 100%; margin: 0; padding: 0; }
        #map { height: 70vh; width: 100%; }
        .map-header { 
            padding: 10px; 
            background: white; 
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .lightbox-images {
            margin: 10px;
        }
        .lightbox-images img {
            width: 100px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="map-header">
        <h3>{{ observation.title }}</h3>
        <p>Coordinates: {{ lat|default:0 }}, {{ lng|default:0 }}</p>
    </div>
    <div id="map"></div>

    <!-- Lightbox images -->
    <div class="lightbox-images">
        {% for img in observation.images.all %}
            <a href="{{ img.image.url }}" data-lightbox="obs-gallery">
                <img src="{{ img.image.url }}" alt="Observation Image">
            </a>
        {% endfor %}
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
    <script>
        // Ensure numeric coordinates
        const lat = parseFloat("{{ lat|default:'0' }}");
        const lng = parseFloat("{{ lng|default:'0' }}");

        if (!isNaN(lat) && !isNaN(lng)) {
            const map = L.map('map').setView([lat, lng], 17);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            L.marker([lat, lng])
                .addTo(map)
                .bindPopup("{{ observation.title }}<br>Coordinates: " + lat + ", " + lng)
                .openPopup();
        } else {
            document.getElementById('map').innerHTML = "<p style='text-align:center;margin-top:20px;'>Invalid coordinates</p>";
        }
    </script>
</body>
</html>
